<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raags Database</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>ðŸŽµ Raags Database</h1>
    <nav>
      <a href="raags.html">Raags</a>
      <a href="thaats.html">Thaats</a>
      <a href="tetrachords.html">Tetrachords</a>
      <div style="position: relative;">
        <button class="menu-btn">â˜° Menu</button>
        <div class="menu-dropdown">
          <div class="menu-section">
            <h3>Login</h3>
            <button onclick="alert('Login functionality coming soon!')">Login</button>
          </div>
          
          <div class="menu-section">
            <h3>Display Settings</h3>
            <label><input type="radio" name="notation" value="hindustani" checked> Hindustani Sargam</label>
            <label><input type="radio" name="notation" value="carnatic"> Carnatic Sargam</label>
            <label><input type="radio" name="notation" value="western"> Western Notation</label>
            <label><input type="radio" name="notation" value="midi"> MIDI Values</label>
          </div>
          
          <div class="menu-section">
            <h3>Visibility Settings</h3>
            <label><input type="checkbox" class="column-toggle" data-column="id" checked> ID</label>
            <label><input type="checkbox" class="column-toggle" data-column="name" checked> Name</label>
            <label><input type="checkbox" class="column-toggle" data-column="aaroh" checked> Aaroh</label>
            <label><input type="checkbox" class="column-toggle" data-column="avaroh" checked> Avaroh</label>
            <label><input type="checkbox" class="column-toggle" data-column="thaat_id" checked> Thaat ID</label>
            <label><input type="checkbox" class="column-toggle" data-column="jaati_aaroh" checked> Jaati Aaroh</label>
            <label><input type="checkbox" class="column-toggle" data-column="jaati_avaroh" checked> Jaati Avaroh</label>
            <label><input type="checkbox" class="column-toggle" data-column="varient_difference" checked> Variant Diff</label>
            <label><input type="checkbox" class="column-toggle" data-column="alternate_names" checked> Alt Names</label>
            <label><input type="checkbox" class="column-toggle" data-column="shuddhataa_rank" checked> Shuddhataa Rank</label>
            <label><input type="checkbox" class="column-toggle" data-column="largest_gap" checked> Largest Gap</label>
            <label><input type="checkbox" class="column-toggle" data-column="popularity" checked> Popularity</label>
            <label><input type="checkbox" class="column-toggle" data-column="dimension" checked> Dimension</label>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main>
    <div class="controls">
      <div class="control-row">
        <div class="search-box">
          <label for="aaroh-search">Search Aaroh</label>
          <input type="text" id="aaroh-search" placeholder="Enter svar value (e.g., 0, 2, 4...)">
        </div>
        <div class="search-box">
          <label for="avaroh-search">Search Avaroh</label>
          <input type="text" id="avaroh-search" placeholder="Enter svar value (e.g., 12, 11, 9...)">
        </div>
      </div>
      
      <div class="control-row">
        <div class="filter-group">
          <label for="varient-filter">Variant Difference</label>
          <select id="varient-filter">
            <option value="all">All</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="gap-filter">Largest Gap</label>
          <select id="gap-filter">
            <option value="all">All</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="thaat-filter">Thaat ID</label>
          <select id="thaat-filter">
            <option value="all">All</option>
          </select>
        </div>
      </div>
      
      <div class="control-row">
        <button onclick="applyFilters()" style="padding: 0.6rem 2rem; background: var(--electric-turquoise); color: var(--darker-purple); border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Apply Filters</button>
        <button onclick="resetFilters()" style="padding: 0.6rem 2rem; background: var(--medium-purple); color: var(--electric-turquoise); border: 1px solid var(--electric-purple); border-radius: 5px; cursor: pointer;">Reset</button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-column="id">ID</th>
            <th class="sortable" data-column="name">Name</th>
            <th class="sortable" data-column="aaroh">Aaroh</th>
            <th class="sortable" data-column="avaroh">Avaroh</th>
            <th class="sortable" data-column="thaat_id">Thaat ID</th>
            <th class="sortable" data-column="jaati_aaroh">Jaati Aaroh</th>
            <th class="sortable" data-column="jaati_avaroh">Jaati Avaroh</th>
            <th class="sortable" data-column="varient_difference">Variant Diff</th>
            <th class="sortable" data-column="alternate_names">Alt Names</th>
            <th class="sortable" data-column="shuddhataa_rank">Shuddhataa</th>
            <th class="sortable" data-column="largest_gap">Largest Gap</th>
            <th class="sortable" data-column="popularity">Popularity</th>
            <th class="sortable" data-column="dimension">Dimension</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="13" style="text-align: center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Hindustani Raag Database | Data-driven classical music exploration</p>
  </footer>

  <script src="svarmap.js"></script>
  <script src="database.js"></script>
  <script src="table-utils.js"></script>
  <script>
    // Page-specific logic
    async function loadData() {
      showLoading();
      try {
        const data = await fetchTableData('raags');
        renderTable(data);
        setupSorting(document.querySelector('table'));
        
        // Populate thaat filter
        const thaatFilter = document.getElementById('thaat-filter');
        const uniqueThaats = [...new Set(data.map(r => r.thaat_id).filter(Boolean))].sort((a,b) => a-b);
        uniqueThaats.forEach(id => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = id;
          thaatFilter.appendChild(option);
        });
      } catch (error) {
        showError(error.message);
      }
    }

    async function applyFilters() {
      showLoading();
      try {
        const aarohSearch = document.getElementById('aaroh-search').value.trim();
        const avarohSearch = document.getElementById('avaroh-search').value.trim();
        const varientFilter = document.getElementById('varient-filter').value;
        const gapFilter = document.getElementById('gap-filter').value;
        const thaatFilter = document.getElementById('thaat-filter').value;

        const filters = {};
        if (varientFilter !== 'all') filters.varient_difference = varientFilter;
        if (gapFilter !== 'all') filters.largest_gap = gapFilter;
        if (thaatFilter !== 'all') filters.thaat_id = thaatFilter;

        let data;
        if (aarohSearch) {
          data = await searchInArrayColumn('raags', 'aaroh', aarohSearch);
        } else if (avarohSearch) {
          data = await searchInArrayColumn('raags', 'avaroh', avarohSearch);
        } else {
          data = await fetchTableData('raags', filters);
        }

        // Apply additional filters if search was used
        if ((aarohSearch || avarohSearch) && Object.keys(filters).length > 0) {
          for (const [key, value] of Object.entries(filters)) {
            data = data.filter(row => row[key] == value);
          }
        }

        renderTable(data);
        setupSorting(document.querySelector('table'));
      } catch (error) {
        showError(error.message);
      }
    }

    function resetFilters() {
      document.getElementById('aaroh-search').value = '';
      document.getElementById('avaroh-search').value = '';
      document.getElementById('varient-filter').value = 'all';
      document.getElementById('gap-filter').value = 'all';
      document.getElementById('thaat-filter').value = 'all';
      loadData();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initializePage('raags');
      loadData(); // Call loadData after initialization
    });
  </script>
</body>
</html>